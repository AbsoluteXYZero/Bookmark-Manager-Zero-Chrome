image: python:3.12-slim

stages:
  - deploy

pages:
  stage: deploy
  script:
    - pip install --no-cache-dir markdown markdown-it-py mdit-py-plugins linkify-it-py

    # Create Pages root
    - mkdir -p public

    # Copy only non-sensitive files into public/
    - |
      shopt -s dotglob
      for item in *; do
        if [[ "$item" != "public" && "$item" != ".git" && "$item" != ".gitlab-ci.yml" ]]; then
          cp -r "$item" public/
        fi
      done

    # Generate privacy.html from PRIVACY.md
    - |
      python << 'EOF'
      import markdown, pathlib

      md_path = pathlib.Path("public/PRIVACY.md")
      if md_path.exists():
          html = markdown.markdown(
              md_path.read_text(),
              extensions=["tables","fenced_code","attr_list","sane_lists"]
          )
          pathlib.Path("public/privacy.html").write_text(html)
      EOF

    # Generate index.html from README.md with proper styling
    - |
      python << 'PYEOF'
      from markdown_it import MarkdownIt
      from mdit_py_plugins.deflist import deflist_plugin
      import pathlib

      readme_path = pathlib.Path("public/README.md")
      if readme_path.exists():
          # Convert markdown to HTML using markdown-it-py with all GFM features
          md = (
              MarkdownIt("commonmark", {"breaks": True, "html": True})
              .enable("table")
              .enable("strikethrough")
          )
          html_content = md.render(readme_path.read_text(encoding='utf-8'))

          # Wrap in a full HTML page with GitHub-style CSS
          html_start = """<!DOCTYPE html>
      <html lang="en">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Bookmark Manager Zero - Chrome Extension</title>
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5/github-markdown.min.css">
          <style>
              body {
                  box-sizing: border-box;
                  min-width: 200px;
                  max-width: 980px;
                  margin: 0 auto;
                  padding: 45px;
                  background-color: #ffffff;
              }
              .markdown-body {
                  box-sizing: border-box;
                  min-width: 200px;
                  max-width: 100%;
              }
              .markdown-body img {
                  max-width: 100%;
                  height: auto;
              }
              @media (prefers-color-scheme: dark) {
                  body {
                      background-color: #0d1117;
                  }
              }
              @media (max-width: 767px) {
                  body {
                      padding: 15px;
                  }
              }
          </style>
      </head>
      <body class="markdown-body">
      """
          html_end = """
      </body>
      </html>"""

          full_html = html_start + html_content + html_end
          pathlib.Path("public/index.html").write_text(full_html, encoding='utf-8')
      PYEOF

  artifacts:
    paths:
      - public
